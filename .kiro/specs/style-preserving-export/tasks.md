# 実装計画

- [x] 1. 新規値オブジェクトと列挙型の作成
- [x] 1.1 色表現の値オブジェクトを作成する
  - RGB hex 値とテーマカラー参照（テーマインデックス + ティント）の両方を統一的に表現できる不変の値オブジェクトを実装する
  - インデックスカラーと自動色フラグにも対応する
  - Equatable による等値比較を実装し、テーマ参照か RGB かを判別するヘルパーを提供する
  - ライブラリエントリポイントに新規ファイルを登録する
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 1.2 セル保護の値オブジェクトとフォント垂直配置の列挙型を追加する
  - ロック状態と数式非表示状態を保持するセル保護の値オブジェクトを実装する（Excel 標準デフォルト: locked=true, hidden=false）
  - 上付き・下付き文字を表現するフォント垂直配置の列挙型（none, superscript, subscript）を既存の列挙型ファイルに追加する
  - Equatable による等値比較を実装する
  - ライブラリエントリポイントに新規ファイルを登録する
  - _Requirements: 2.3, 5.1_

- [x] 1.3 塗りつぶし表現の値オブジェクトを作成する
  - OOXML の全パターンタイプ（none, solid, gray125, darkGrid 等 19 種）を文字列として表現できる塗りつぶし値オブジェクトを実装する
  - 前景色（fgColor）と背景色（bgColor）を色値オブジェクトで個別に保持し、テーマカラー参照にも対応する
  - Equatable による等値比較を実装する
  - ライブラリエントリポイントに新規ファイルを登録する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2. 既存モデルの拡張
- [x] 2.1 CellStyle の拡張と Excel クラスのフィールド追加
  - アライメント拡張プロパティ（indent, readingOrder, justifyLastLine, relativeIndent）を追加する
  - フォント拡張プロパティ（取り消し線、フォント垂直配置）を追加する
  - テーマカラー対応の色プロパティ（fontColor, backgroundColor）と塗りつぶし値オブジェクト（fill）のプロパティを追加する
  - セル保護（protection）とスタイル参照 ID（xfId）のプロパティを追加する
  - 既存の fontColorHex / backgroundColorHex getter/setter を新しい色値オブジェクト経由の内部実装に変更し、後方互換性を維持する
  - 全新規プロパティにデフォルト値を設定し、既存コードが変更なく動作することを保証する
  - Equatable の props に全新規フィールドを追加する
  - Excel クラスに cellStyleXfs / cellStyles セクションの Raw XML 保持用フィールドを追加する
  - Excel クラスのパターン塗りつぶしリストの型を塗りつぶし値オブジェクトのリストに変更する
  - _Requirements: 1.4, 1.5, 2.2, 2.3, 5.1, 5.3, 5.4, 8.1, 8.2_

- [x] 2.2 (P) _FontStyle の修正と Border の拡張
  - フォントスタイルの等値比較（Equatable props）に fontScheme を追加する
  - フォントスタイルに取り消し線フラグ、フォント垂直配置、テーマカラー対応の色フィールドを追加する
  - 罫線モデルにテーマカラー対応の色プロパティを追加し、既存の borderColorHex との後方互換性を維持する
  - Equatable の props に全新規フィールドを追加する
  - _Requirements: 2.4, 6.3_

- [x] 3. パーサーの修正（タスク 4 と並行実行可能）
- [x] 3.1 アライメントと下線パースの既知バグを修正する
  - アライメント属性（horizontal, vertical, textRotation）の読み取り元を xf 要素から alignment 子要素に修正する（3 箇所）
  - 下線パースで Double が Single に上書きされるバグを修正し、val 属性値に基づく正確な分岐ロジックに変更する（val なし → Single、val="double" → Double、その他 → Single）
  - _Requirements: 1.1, 1.2, 1.3, 2.1_

- [x] 3.2 拡張属性・テーマカラー・塗りつぶし・保護のパース処理を追加する
  - アライメント拡張属性（indent, readingOrder, justifyLastLine, relativeIndent）を alignment 子要素からパースする
  - フォント拡張属性（strike 要素による取り消し線、vertAlign 要素による上付き/下付き）をパースする
  - 色要素を共通的にパースするヘルパー関数を新設し、rgb / theme / tint / indexed / auto を統一的に色値オブジェクトとして読み取る
  - フォント色、塗りつぶし前景色/背景色、罫線色の全箇所でテーマカラー参照を色値オブジェクトとしてパースする
  - パターン塗りつぶしの詳細情報（patternType, fgColor, bgColor）を塗りつぶし値オブジェクトとしてパースする
  - セル保護属性（locked, hidden）を protection 子要素からパースする
  - xfId 属性をパースして CellStyle に格納する
  - cellStyleXfs / cellStyles セクションの Raw XML を Excel クラスのフィールドに保持する
  - _Requirements: 1.4, 1.5, 2.2, 2.3, 3.2, 3.3, 5.1, 5.3, 5.4, 6.1, 6.2, 6.3_

- [ ] 4. エクスポーターの修正（タスク 3 と並行実行可能）
- [ ] 4.1 apply* 属性と xfId の出力を修正する
  - borderId > 0 の場合に applyBorder="1" を出力する
  - fontId > 0 の場合に applyFont="1" を出力する（既存のロジックバグを修正）
  - numFmtId > 0 の場合に applyNumberFormat="1" を出力する
  - fillId > 0 の場合に applyFill="1" を出力する
  - アライメントがデフォルト以外の場合に applyAlignment="1" を出力する
  - xfId を元の値のまま出力する（0 へのハードコードを修正）
  - _Requirements: 4.1, 4.2, 4.3, 5.3_

- [ ] 4.2 テーマカラー・塗りつぶし・保護・アライメント・フォントの完全出力と cellStyleXfs/cellStyles 透過
  - 色値オブジェクトの内容に応じて theme/tint 属性または rgb 属性として色要素を出力する共通ヘルパーを実装する
  - フォント色、塗りつぶし色、罫線色の全箇所でテーマカラー参照を元の形式で再出力する
  - 塗りつぶし値オブジェクトのパターンタイプ・前景色・背景色を正確に出力する（全 OOXML パターンタイプ対応）
  - セル保護属性（locked, hidden）を protection 子要素として出力する
  - アライメントの全属性（既存 5 属性 + 拡張 4 属性: indent, readingOrder, justifyLastLine, relativeIndent）を出力する
  - フォント出力に取り消し線（strike）、上付き/下付き（vertAlign）、テーマカラーを追加する
  - cellStyleXfs セクションを Raw XML として cellXfs の前に再挿入する
  - cellStyles セクションを Raw XML として cellXfs の後に再挿入する
  - _Requirements: 2.2, 2.3, 3.1, 3.2, 3.3, 5.1, 5.2, 5.4, 6.1, 6.2, 6.3, 7.2_

- [ ] 5. スタイルインデックス管理と統合検証
- [ ] 5.1 スタイルインデックス管理ロジックを実装する
  - 元スタイルリストの全エントリを保持し、新規/変更スタイルを末尾に追加する差分方式を実装する
  - フォント・塗りつぶし・罫線の重複排除ロジックを実装する（同一定義は同じ ID にマッピング）
  - 未変更セルのスタイルインデックス（s 属性）を元の値のまま保持する
  - 変更セルには統合スタイルリスト内の正しい位置をスタイルインデックスとして設定する
  - 参照先が存在しないインデックスはデフォルトスタイル（インデックス 0）にフォールバックする矛盾検出を実装する
  - _Requirements: 7.3, 7.4, 7.5_

- [ ] 5.2 ラウンドトリップ統合テストと既存テストの回帰確認
  - スタイル変更なしでのエクスポートで styles.xml が元ファイルと同一内容であることを確認する
  - スタイル変更ありでのエクスポートで有効な OOXML 構造が出力されることを確認する
  - アライメント・テーマカラー・パターン塗りつぶし・下線・保護属性のラウンドトリップ（インポート→エクスポート→再インポート）で全属性が保持されることを確認する
  - 新規セルにスタイルを適用した場合のインデックス整合性を確認する
  - 既存テストスイートが全件パスすることを確認する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 8.3_
